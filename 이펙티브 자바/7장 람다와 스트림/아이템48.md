# 스트림 병렬화는 주의해서 적용하라
## parallel 메서드
자바 8부터는 parallel 메서드만 한 번 호출해서 파이프라인을 병렬 실행할 수 있는 스트림을 지원한다.
```java
primes().parrallel()
        .map(p -> TWO.pow(p.intValueExact()).subtract(ONE))
        .filter(mersenne -> mersenne.isProbablePrime(50))
        .limit(20)
        .forEach(System.out::println); // 아무것도 출력되지 않는다. 스트림 라이브러리가 파이프라인을 병렬화하는 방법을 찾아내지 못하기 떄문이다.
```
Stream.iterate거나 중간 연산으로 limit를 쓰면 병렬화로 성능 개선을 이룰 수 없다. limit를 사용할 경우 제한 갯수 이후의 결과를 버려도 Integrity는 깨지지 않음을 가정한다. 매 소수마다 새로운 계산을 하기 때문에 성능이 굉장히 저하된다.
## parallel()를 적용하는 기준
스트림의 소스가 ArrayList, HashMap, HashSet, ConcurrentHashMap의 인스턴스거나, 배열, int범위, long 범위 등 쪼개기 쉬울 때 병렬화의 효과가 가장 좋다.
- 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있어서 스레드 분배하기 좋다.
- 위의 자료구조들은 참조 지역성이 뛰어나다. 이웃한 원소의 참조들이 메모리에 연속해서 저장되어 있다. 이 성능이 좋아진다.(기본타입 배열이 참조 지역성이 가장 좋다.)
- 참조 지역성이 낮으면, 스레드는 데이터가 주 메모리에서 캐시 메모리로 전송되어 오기를 기다리며 시간을 보내게 된다.
## 종단 연산과 병렬 수행 효율
종단 연산의 동작방식도 병렬 수행 효율에 영향을 미친다.
- 스트림의 요소를 하나씩 순차적으로 처리하는 상황에서는 병렬화의 효과가 가장 좋다.
  - 특정 집계 연산, 조건에 맞으면 반환하는 등의 메서드(min, max, count, sum) 는 병렬화하기 좋다.
  - 조건에 맞으면 바로 반환하는 메서드 (anyMatch, allMatch, noneMatch) 는 병렬화하기 좋다.
- 가장 병렬 연산에 적합한 것은 reduction이다. 

spliterator()를 재정의하고 스트림의 병렬화 성능을 강도 높게 테스트 후에 parallel()을 호출하자.
조건에 맞으면 parallel 하나로 프로세서 코어 수에 비례하는 성능을 개선할 수 있다.

## 안전 실패
스트림을 잘못 병렬화하면 성능이 나빠질 뿐만 아니라 결과 자체가 잘못되거나 예상 못한 동작이 발생할 수 있다. 결과가 잘못되거나 오작동하는 것을 ** 안전 실패**라고 한다.
안전실패가 일어나지 않게 만들기 위해서는 Stream의 명세를 잘 지켜야 한다.
- 스트림 파이프라인의 각 단계에서 수행하는 일이 스트림의 상태에 따라 달라지는 함수를 전달해서는 안된다.
- accumulator, combiner 함수는 반드시 결합법칙을 만족하고, 간섭받지 않아야 하고, 상태를 가져서는 안된다.
## 병렬화 좋은 예
```java
public long pi(long n) {
    return LongStream.range(2, n)
        .parallel()
        .mapToObj(BigInteger::valueOf)
        .filter(i -> i.isProbablePrime(50))
        .count();   
} // 2부터 n까지의 소수의 갯수를 반환한다.
```
위의 코드는 병렬화의 좋은 예로 병렬화의 효과가 가장 좋은 상황이다. 숫자들을 일정부분씩 쪼개 조건에 결과에 따라 나누면 된다. 
무작위 수로 이뤄진 스트림을 병렬화 하고 싶다면 ThreadLocalRandom 혹은 Random보다는 SplittableRandom 인스턴스를 이용하는 것이 좋다. SplittableRandom은 스트림을 병렬화하기에 적합한 난수 생성기이다.
## 핵심 정리
무작정 병렬화하는 것은 오히려 성능 저하 뿐만아니라 잘못된 결과를 도출하기도 한다. 따라서 병렬화할 때는 Stream의 명세를 잘 지키고 오동작과 부작용도 항상 고려해야 한다. (성능지표를 확인하자)
